{
  "type": "excalidraw",
  "version": 2,
  "source": "https://excalidraw.com",
  "elements": [
    {"id": "phase1-bg", "type": "rectangle", "x": 40, "y": 40, "width": 920, "height": 580, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 1, "opacity": 30, "roundness": {"type": 3}},
    {"id": "phase1-title", "type": "text", "x": 60, "y": 60, "width": 300, "height": 28, "text": "QueryPlan 优化阶段", "fontSize": 20, "fontFamily": 4, "textAlign": "left", "strokeColor": "#1971c2"},

    {"id": "func-title", "type": "rectangle", "x": 280, "y": 100, "width": 440, "height": 40, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-func-detect", "type": "arrow"}]},
    {"id": "func-title-text", "type": "text", "x": 330, "y": 108, "width": 340, "height": 24, "text": "optimizeLazyMaterialization2()", "fontSize": 16, "fontFamily": 4, "textAlign": "center"},

    {"id": "detect", "type": "rectangle", "x": 100, "y": 180, "width": 200, "height": 50, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-func-detect", "type": "arrow"}, {"id": "arr-detect-dag", "type": "arrow"}]},
    {"id": "detect-text", "type": "text", "x": 110, "y": 188, "width": 180, "height": 34, "text": "检测 Limit→Sort→Read\n模式", "fontSize": 14, "fontFamily": 4, "textAlign": "center"},

    {"id": "dag", "type": "rectangle", "x": 400, "y": 180, "width": 200, "height": 50, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-detect-dag", "type": "arrow"}, {"id": "arr-dag-main", "type": "arrow"}, {"id": "arr-dag-lazy", "type": "arrow"}]},
    {"id": "dag-text", "type": "text", "x": 410, "y": 188, "width": 180, "height": 34, "text": "列依赖分析 + DAG拆分\nmain_steps / lazy_steps", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "main-bg", "type": "rectangle", "x": 60, "y": 270, "width": 280, "height": 300, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 1, "opacity": 50, "roundness": {"type": 3}, "boundElements": [{"id": "arr-dag-main", "type": "arrow"}, {"id": "arr-main-join", "type": "arrow"}]},
    {"id": "main-title", "type": "text", "x": 140, "y": 280, "width": 120, "height": 20, "text": "main_plan", "fontSize": 14, "fontFamily": 4, "textAlign": "center", "strokeColor": "#1971c2"},

    {"id": "read-main", "type": "rectangle", "x": 80, "y": 310, "width": 240, "height": 45, "backgroundColor": "#ffffff", "strokeColor": "#1971c2", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-read-expr", "type": "arrow"}]},
    {"id": "read-main-text", "type": "text", "x": 90, "y": 318, "width": 220, "height": 30, "text": "ReadFromMergeTree\n(只读主列+虚拟列)", "fontSize": 11, "fontFamily": 4, "textAlign": "center"},

    {"id": "expr-step", "type": "rectangle", "x": 80, "y": 370, "width": 240, "height": 40, "backgroundColor": "#ffffff", "strokeColor": "#1971c2", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-read-expr", "type": "arrow"}, {"id": "arr-expr-sort", "type": "arrow"}]},
    {"id": "expr-step-text", "type": "text", "x": 90, "y": 378, "width": 220, "height": 24, "text": "ExpressionStep(__global_row_idx)", "fontSize": 11, "fontFamily": 4, "textAlign": "center"},

    {"id": "sort-step", "type": "rectangle", "x": 80, "y": 425, "width": 240, "height": 35, "backgroundColor": "#ffffff", "strokeColor": "#1971c2", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-expr-sort", "type": "arrow"}, {"id": "arr-sort-limit", "type": "arrow"}]},
    {"id": "sort-step-text", "type": "text", "x": 150, "y": 433, "width": 100, "height": 20, "text": "SortingStep", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "limit-step", "type": "rectangle", "x": 80, "y": 475, "width": 240, "height": 35, "backgroundColor": "#ffffff", "strokeColor": "#1971c2", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-sort-limit", "type": "arrow"}]},
    {"id": "limit-step-text", "type": "text", "x": 160, "y": 483, "width": 80, "height": 20, "text": "LimitStep", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "lazy-bg", "type": "rectangle", "x": 660, "y": 270, "width": 280, "height": 120, "backgroundColor": "#fff3bf", "strokeColor": "#e67700", "strokeWidth": 1, "opacity": 50, "roundness": {"type": 3}, "boundElements": [{"id": "arr-dag-lazy", "type": "arrow"}, {"id": "arr-lazy-join", "type": "arrow"}]},
    {"id": "lazy-title", "type": "text", "x": 750, "y": 280, "width": 100, "height": 20, "text": "lazy_plan", "fontSize": 14, "fontFamily": 4, "textAlign": "center", "strokeColor": "#e67700"},

    {"id": "read-lazy", "type": "rectangle", "x": 680, "y": 310, "width": 240, "height": 60, "backgroundColor": "#ffffff", "strokeColor": "#e67700", "strokeWidth": 1, "roundness": {"type": 3}},
    {"id": "read-lazy-text", "type": "text", "x": 690, "y": 320, "width": 220, "height": 40, "text": "LazilyReadFromMergeTree\n(只读延迟列)", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "join-step", "type": "rectangle", "x": 350, "y": 530, "width": 300, "height": 60, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-main-join", "type": "arrow"}, {"id": "arr-lazy-join", "type": "arrow"}, {"id": "arr-join-pipeline", "type": "arrow"}]},
    {"id": "join-step-text", "type": "text", "x": 370, "y": 540, "width": 260, "height": 40, "text": "JoinLazyColumnsStep\n(绑定 LazyMaterializingRows 共享状态)", "fontSize": 11, "fontFamily": 4, "textAlign": "center"},

    {"id": "arr-func-detect", "type": "arrow", "x": 500, "y": 145, "points": [[0, 0], [-300, 0], [-300, 30]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 1, "startBinding": {"elementId": "func-title", "focus": 0, "gap": 5}, "endBinding": {"elementId": "detect", "focus": 0, "gap": 5}},
    {"id": "arr-detect-dag", "type": "arrow", "x": 305, "y": 205, "points": [[0, 0], [90, 0]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 1, "startBinding": {"elementId": "detect", "focus": 0, "gap": 5}, "endBinding": {"elementId": "dag", "focus": 0, "gap": 5}},
    {"id": "arr-dag-main", "type": "arrow", "x": 400, "y": 230, "points": [[0, 0], [-200, 40]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 1, "startBinding": {"elementId": "dag", "focus": -0.5, "gap": 5}, "endBinding": {"elementId": "main-bg", "focus": 0, "gap": 5}},
    {"id": "arr-dag-lazy", "type": "arrow", "x": 600, "y": 230, "points": [[0, 0], [200, 40]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 1, "startBinding": {"elementId": "dag", "focus": 0.5, "gap": 5}, "endBinding": {"elementId": "lazy-bg", "focus": 0, "gap": 5}},
    {"id": "arr-read-expr", "type": "arrow", "x": 200, "y": 360, "points": [[0, 0], [0, 5]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 1, "startBinding": {"elementId": "read-main", "focus": 0, "gap": 5}, "endBinding": {"elementId": "expr-step", "focus": 0, "gap": 5}},
    {"id": "arr-expr-sort", "type": "arrow", "x": 200, "y": 415, "points": [[0, 0], [0, 5]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 1, "startBinding": {"elementId": "expr-step", "focus": 0, "gap": 5}, "endBinding": {"elementId": "sort-step", "focus": 0, "gap": 5}},
    {"id": "arr-sort-limit", "type": "arrow", "x": 200, "y": 465, "points": [[0, 0], [0, 5]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 1, "startBinding": {"elementId": "sort-step", "focus": 0, "gap": 5}, "endBinding": {"elementId": "limit-step", "focus": 0, "gap": 5}},
    {"id": "arr-main-join", "type": "arrow", "x": 340, "y": 420, "points": [[0, 0], [160, 105]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 1, "startBinding": {"elementId": "main-bg", "focus": 0.5, "gap": 5}, "endBinding": {"elementId": "join-step", "focus": -0.5, "gap": 5}},
    {"id": "arr-lazy-join", "type": "arrow", "x": 660, "y": 390, "points": [[0, 0], [-160, 135]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 1, "startBinding": {"elementId": "lazy-bg", "focus": 0, "gap": 5}, "endBinding": {"elementId": "join-step", "focus": 0.5, "gap": 5}},

    {"id": "phase2-bg", "type": "rectangle", "x": 40, "y": 640, "width": 920, "height": 180, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 1, "opacity": 30, "roundness": {"type": 3}},
    {"id": "phase2-title", "type": "text", "x": 60, "y": 660, "width": 300, "height": 28, "text": "QueryPipeline 构建阶段", "fontSize": 20, "fontFamily": 4, "textAlign": "left", "strokeColor": "#2f9e44"},

    {"id": "update-pipeline", "type": "rectangle", "x": 300, "y": 700, "width": 400, "height": 40, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-join-pipeline", "type": "arrow"}, {"id": "arr-pipeline-transform", "type": "arrow"}]},
    {"id": "update-pipeline-text", "type": "text", "x": 340, "y": 708, "width": 320, "height": 24, "text": "JoinLazyColumnsStep::updatePipeline()", "fontSize": 14, "fontFamily": 4, "textAlign": "center"},

    {"id": "lazy-transform", "type": "rectangle", "x": 300, "y": 760, "width": 400, "height": 45, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-pipeline-transform", "type": "arrow"}, {"id": "arr-transform-exec-a", "type": "arrow"}, {"id": "arr-transform-exec-b", "type": "arrow"}]},
    {"id": "lazy-transform-text", "type": "text", "x": 320, "y": 768, "width": 360, "height": 30, "text": "LazilyMaterializingTransform\n(双输入: main_input + lazy_input)", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "arr-join-pipeline", "type": "arrow", "x": 500, "y": 595, "points": [[0, 0], [0, 100]], "endArrowhead": "arrow", "strokeColor": "#2f9e44", "strokeWidth": 1, "startBinding": {"elementId": "join-step", "focus": 0, "gap": 5}, "endBinding": {"elementId": "update-pipeline", "focus": 0, "gap": 5}},
    {"id": "arr-pipeline-transform", "type": "arrow", "x": 500, "y": 745, "points": [[0, 0], [0, 10]], "endArrowhead": "arrow", "strokeColor": "#2f9e44", "strokeWidth": 1, "startBinding": {"elementId": "update-pipeline", "focus": 0, "gap": 5}, "endBinding": {"elementId": "lazy-transform", "focus": 0, "gap": 5}},

    {"id": "phase3-bg", "type": "rectangle", "x": 40, "y": 840, "width": 920, "height": 520, "backgroundColor": "#d0bfff", "strokeColor": "#7048e8", "strokeWidth": 1, "opacity": 30, "roundness": {"type": 3}},
    {"id": "phase3-title", "type": "text", "x": 60, "y": 860, "width": 200, "height": 28, "text": "执行阶段", "fontSize": 20, "fontFamily": 4, "textAlign": "left", "strokeColor": "#7048e8"},

    {"id": "exec-a-bg", "type": "rectangle", "x": 60, "y": 900, "width": 420, "height": 220, "backgroundColor": "#d0bfff", "strokeColor": "#7048e8", "strokeWidth": 1, "opacity": 50, "roundness": {"type": 3}, "boundElements": [{"id": "arr-transform-exec-a", "type": "arrow"}, {"id": "arr-exec-a-output", "type": "arrow"}]},
    {"id": "exec-a-title", "type": "text", "x": 200, "y": 910, "width": 140, "height": 20, "text": "阶段 A: 主分支执行", "fontSize": 14, "fontFamily": 4, "textAlign": "center", "strokeColor": "#7048e8"},

    {"id": "main-pipeline", "type": "rectangle", "x": 80, "y": 940, "width": 380, "height": 35, "backgroundColor": "#ffffff", "strokeColor": "#7048e8", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-main-pipe-prep", "type": "arrow"}]},
    {"id": "main-pipeline-text", "type": "text", "x": 90, "y": 948, "width": 360, "height": 20, "text": "MergeTreeSource → Expression → Sorting → Limit", "fontSize": 11, "fontFamily": 4, "textAlign": "center"},

    {"id": "prep-main", "type": "rectangle", "x": 80, "y": 990, "width": 380, "height": 55, "backgroundColor": "#ffffff", "strokeColor": "#7048e8", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-main-pipe-prep", "type": "arrow"}]},
    {"id": "prep-main-text", "type": "text", "x": 90, "y": 998, "width": 360, "height": 40, "text": "prepareMainChunk()\n提取 __global_row_index, 填充 LazyMaterializingRows", "fontSize": 11, "fontFamily": 4, "textAlign": "center"},

    {"id": "exec-b-bg", "type": "rectangle", "x": 520, "y": 900, "width": 420, "height": 300, "backgroundColor": "#fff3bf", "strokeColor": "#e67700", "strokeWidth": 1, "opacity": 50, "roundness": {"type": 3}, "boundElements": [{"id": "arr-transform-exec-b", "type": "arrow"}, {"id": "arr-exec-b-output", "type": "arrow"}]},
    {"id": "exec-b-title", "type": "text", "x": 650, "y": 910, "width": 160, "height": 20, "text": "阶段 B: 延迟分支执行", "fontSize": 14, "fontFamily": 4, "textAlign": "center", "strokeColor": "#e67700"},

    {"id": "lazy-prepare", "type": "rectangle", "x": 540, "y": 940, "width": 380, "height": 35, "backgroundColor": "#ffffff", "strokeColor": "#e67700", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-lazy-expand", "type": "arrow"}]},
    {"id": "lazy-prepare-text", "type": "text", "x": 550, "y": 948, "width": 360, "height": 20, "text": "LazyReadFromMergeTreeSource::prepare() → ExpandPipeline", "fontSize": 10, "fontFamily": 4, "textAlign": "center"},

    {"id": "expand-pipeline", "type": "rectangle", "x": 540, "y": 990, "width": 380, "height": 55, "backgroundColor": "#ffffff", "strokeColor": "#e67700", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-lazy-expand", "type": "arrow"}, {"id": "arr-expand-prep", "type": "arrow"}]},
    {"id": "expand-pipeline-text", "type": "text", "x": 550, "y": 998, "width": 360, "height": 40, "text": "expandPipeline() → buildReaders()\n基于过滤后的 ranges 创建多个 MergeTreeSource 并发读取", "fontSize": 10, "fontFamily": 4, "textAlign": "center"},

    {"id": "prep-lazy", "type": "rectangle", "x": 540, "y": 1060, "width": 380, "height": 55, "backgroundColor": "#ffffff", "strokeColor": "#e67700", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-expand-prep", "type": "arrow"}]},
    {"id": "prep-lazy-text", "type": "text", "x": 550, "y": 1068, "width": 360, "height": 40, "text": "prepareLazyChunk()\n用 inverted_permutation 恢复顺序, 拼接主列+延迟列", "fontSize": 10, "fontFamily": 4, "textAlign": "center"},

    {"id": "output", "type": "rectangle", "x": 350, "y": 1280, "width": 300, "height": 50, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-exec-a-output", "type": "arrow"}, {"id": "arr-exec-b-output", "type": "arrow"}]},
    {"id": "output-text", "type": "text", "x": 400, "y": 1293, "width": 200, "height": 24, "text": "输出完整行给客户端", "fontSize": 16, "fontFamily": 4, "textAlign": "center"},

    {"id": "arr-transform-exec-a", "type": "arrow", "x": 400, "y": 810, "points": [[0, 0], [-130, 85]], "endArrowhead": "arrow", "strokeColor": "#7048e8", "strokeWidth": 1, "startBinding": {"elementId": "lazy-transform", "focus": -0.5, "gap": 5}, "endBinding": {"elementId": "exec-a-bg", "focus": 0, "gap": 5}},
    {"id": "arr-transform-exec-b", "type": "arrow", "x": 600, "y": 810, "points": [[0, 0], [130, 85]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 1, "startBinding": {"elementId": "lazy-transform", "focus": 0.5, "gap": 5}, "endBinding": {"elementId": "exec-b-bg", "focus": 0, "gap": 5}},
    {"id": "arr-main-pipe-prep", "type": "arrow", "x": 270, "y": 980, "points": [[0, 0], [0, 5]], "endArrowhead": "arrow", "strokeColor": "#7048e8", "strokeWidth": 1, "startBinding": {"elementId": "main-pipeline", "focus": 0, "gap": 5}, "endBinding": {"elementId": "prep-main", "focus": 0, "gap": 5}},
    {"id": "arr-lazy-expand", "type": "arrow", "x": 730, "y": 980, "points": [[0, 0], [0, 5]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 1, "startBinding": {"elementId": "lazy-prepare", "focus": 0, "gap": 5}, "endBinding": {"elementId": "expand-pipeline", "focus": 0, "gap": 5}},
    {"id": "arr-expand-prep", "type": "arrow", "x": 730, "y": 1050, "points": [[0, 0], [0, 5]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 1, "startBinding": {"elementId": "expand-pipeline", "focus": 0, "gap": 5}, "endBinding": {"elementId": "prep-lazy", "focus": 0, "gap": 5}},
    {"id": "arr-exec-a-output", "type": "arrow", "x": 270, "y": 1125, "points": [[0, 0], [0, 100], [230, 150]], "endArrowhead": "arrow", "strokeColor": "#7048e8", "strokeWidth": 1, "startBinding": {"elementId": "exec-a-bg", "focus": 0, "gap": 5}, "endBinding": {"elementId": "output", "focus": -0.5, "gap": 5}},
    {"id": "arr-exec-b-output", "type": "arrow", "x": 730, "y": 1205, "points": [[0, 0], [0, 25], [-230, 70]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 1, "startBinding": {"elementId": "exec-b-bg", "focus": 0, "gap": 5}, "endBinding": {"elementId": "output", "focus": 0.5, "gap": 5}}
  ],
  "appState": {"viewBackgroundColor": "#ffffff"},
  "files": {}
}
