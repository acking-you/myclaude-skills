{
  "type": "excalidraw",
  "version": 2,
  "source": "https://excalidraw.com",
  "elements": [
    {"id": "title", "type": "text", "x": 350, "y": 20, "width": 300, "height": 32, "text": "ClickHouse SQL 执行流程", "fontSize": 24, "fontFamily": 4, "textAlign": "center", "strokeColor": "#1e1e1e"},

    {"id": "entry", "type": "rectangle", "x": 350, "y": 80, "width": 200, "height": 50, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-entry-tcp", "type": "arrow"}, {"id": "arr-entry-http", "type": "arrow"}]},
    {"id": "entry-text", "type": "text", "x": 370, "y": 93, "width": 160, "height": 24, "text": "TCP/HTTP 收到 SQL", "fontSize": 14, "fontFamily": 4, "textAlign": "center"},

    {"id": "tcp", "type": "rectangle", "x": 80, "y": 180, "width": 340, "height": 50, "backgroundColor": "#e7f5ff", "strokeColor": "#1971c2", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-entry-tcp", "type": "arrow"}, {"id": "arr-tcp-exec", "type": "arrow"}]},
    {"id": "tcp-text", "type": "text", "x": 90, "y": 188, "width": 320, "height": 34, "text": "TCP: TCPHandler::runImpl()\n调用 executeQuery(...)", "fontSize": 11, "fontFamily": 4, "textAlign": "center"},
    {"id": "tcp-ref", "type": "text", "x": 90, "y": 235, "width": 150, "height": 16, "text": "[TCPHandler.cpp:776]", "fontSize": 10, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "http", "type": "rectangle", "x": 480, "y": 180, "width": 340, "height": 50, "backgroundColor": "#e7f5ff", "strokeColor": "#1971c2", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-entry-http", "type": "arrow"}, {"id": "arr-http-exec", "type": "arrow"}]},
    {"id": "http-text", "type": "text", "x": 490, "y": 188, "width": 320, "height": 34, "text": "HTTP: HTTPHandler::processQuery()\n调用 executeQuery(...)", "fontSize": 11, "fontFamily": 4, "textAlign": "center"},
    {"id": "http-ref", "type": "text", "x": 490, "y": 235, "width": 180, "height": 16, "text": "[HTTPHandler.cpp:608]", "fontSize": 10, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "arr-entry-tcp", "type": "arrow", "x": 400, "y": 135, "points": [[0, 0], [-150, 40]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 2, "startBinding": {"elementId": "entry", "focus": -0.5, "gap": 5}, "endBinding": {"elementId": "tcp", "focus": 0, "gap": 5}},
    {"id": "arr-entry-http", "type": "arrow", "x": 500, "y": 135, "points": [[0, 0], [150, 40]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 2, "startBinding": {"elementId": "entry", "focus": 0.5, "gap": 5}, "endBinding": {"elementId": "http", "focus": 0, "gap": 5}},

    {"id": "exec-query", "type": "rectangle", "x": 200, "y": 290, "width": 500, "height": 90, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-tcp-exec", "type": "arrow"}, {"id": "arr-http-exec", "type": "arrow"}, {"id": "arr-exec-interp", "type": "arrow"}]},
    {"id": "exec-query-text", "type": "text", "x": 220, "y": 300, "width": 460, "height": 70, "text": "executeQuery(...) → executeQueryImpl(...)\n解析 SQL → AST\nInterpreterFactory::get(AST) 创建 Interpreter\ninterpreter->execute()", "fontSize": 12, "fontFamily": 4, "textAlign": "left"},
    {"id": "exec-ref", "type": "text", "x": 710, "y": 300, "width": 200, "height": 50, "text": "[executeQuery.cpp]\n:1955, :1113\n:1684-1686, :1746", "fontSize": 9, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "arr-tcp-exec", "type": "arrow", "x": 250, "y": 235, "points": [[0, 0], [150, 50]], "endArrowhead": "arrow", "strokeColor": "#2f9e44", "strokeWidth": 2, "startBinding": {"elementId": "tcp", "focus": 0, "gap": 5}, "endBinding": {"elementId": "exec-query", "focus": -0.3, "gap": 5}},
    {"id": "arr-http-exec", "type": "arrow", "x": 650, "y": 235, "points": [[0, 0], [-150, 50]], "endArrowhead": "arrow", "strokeColor": "#2f9e44", "strokeWidth": 2, "startBinding": {"elementId": "http", "focus": 0, "gap": 5}, "endBinding": {"elementId": "exec-query", "focus": 0.3, "gap": 5}},

    {"id": "interp-bg", "type": "rectangle", "x": 60, "y": 420, "width": 780, "height": 340, "backgroundColor": "#fff3bf", "strokeColor": "#e67700", "strokeWidth": 1, "opacity": 30, "roundness": {"type": 3}, "boundElements": [{"id": "arr-exec-interp", "type": "arrow"}, {"id": "arr-interp-pipeline", "type": "arrow"}]},
    {"id": "interp-title", "type": "text", "x": 80, "y": 435, "width": 350, "height": 24, "text": "InterpreterSelectQuery::execute()", "fontSize": 16, "fontFamily": 4, "textAlign": "left", "strokeColor": "#e67700"},
    {"id": "interp-ref", "type": "text", "x": 430, "y": 438, "width": 250, "height": 16, "text": "[InterpreterSelectQuery.cpp:1149]", "fontSize": 10, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "build-plan", "type": "rectangle", "x": 100, "y": 480, "width": 320, "height": 60, "backgroundColor": "#fff3bf", "strokeColor": "#e67700", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-plan-pipeline", "type": "arrow"}]},
    {"id": "build-plan-text", "type": "text", "x": 110, "y": 490, "width": 300, "height": 40, "text": "buildQueryPlan(query_plan)\nexecuteImpl(...) 逐步把 Step 加到 QueryPlan", "fontSize": 11, "fontFamily": 4, "textAlign": "left"},
    {"id": "build-plan-ref", "type": "text", "x": 100, "y": 545, "width": 250, "height": 16, "text": "[InterpreterSelectQuery.cpp:1123]", "fontSize": 9, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "build-pipeline", "type": "rectangle", "x": 100, "y": 580, "width": 320, "height": 45, "backgroundColor": "#fff3bf", "strokeColor": "#e67700", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-plan-pipeline", "type": "arrow"}, {"id": "arr-pipeline-opt", "type": "arrow"}]},
    {"id": "build-pipeline-text", "type": "text", "x": 110, "y": 590, "width": 300, "height": 24, "text": "query_plan.buildQueryPipeline(...)", "fontSize": 12, "fontFamily": 4, "textAlign": "left"},
    {"id": "build-pipeline-ref", "type": "text", "x": 100, "y": 630, "width": 180, "height": 16, "text": "[QueryPlan.cpp:175]", "fontSize": 9, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "arr-plan-pipeline", "type": "arrow", "x": 260, "y": 545, "points": [[0, 0], [0, 30]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 2, "startBinding": {"elementId": "build-plan", "focus": 0, "gap": 5}, "endBinding": {"elementId": "build-pipeline", "focus": 0, "gap": 5}},

    {"id": "optimize-bg", "type": "rectangle", "x": 480, "y": 480, "width": 340, "height": 260, "backgroundColor": "#d0bfff", "strokeColor": "#7048e8", "strokeWidth": 1, "opacity": 50, "roundness": {"type": 3}, "boundElements": [{"id": "arr-pipeline-opt", "type": "arrow"}]},
    {"id": "optimize-title", "type": "text", "x": 500, "y": 495, "width": 200, "height": 20, "text": "QueryPlan::optimize(...)", "fontSize": 14, "fontFamily": 4, "textAlign": "left", "strokeColor": "#7048e8"},
    {"id": "optimize-ref", "type": "text", "x": 700, "y": 497, "width": 100, "height": 16, "text": "[QueryPlan.cpp:572]", "fontSize": 9, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "opt-first", "type": "rectangle", "x": 510, "y": 530, "width": 290, "height": 35, "backgroundColor": "#ffffff", "strokeColor": "#7048e8", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-first-second", "type": "arrow"}]},
    {"id": "opt-first-text", "type": "text", "x": 520, "y": 540, "width": 270, "height": 16, "text": "optimizeTreeFirstPass(...)", "fontSize": 12, "fontFamily": 4, "textAlign": "left"},

    {"id": "opt-second", "type": "rectangle", "x": 510, "y": 590, "width": 290, "height": 35, "backgroundColor": "#ffffff", "strokeColor": "#7048e8", "strokeWidth": 1, "roundness": {"type": 3}, "boundElements": [{"id": "arr-first-second", "type": "arrow"}, {"id": "arr-second-lazy", "type": "arrow"}]},
    {"id": "opt-second-text", "type": "text", "x": 520, "y": 600, "width": 270, "height": 16, "text": "optimizeTreeSecondPass(...)", "fontSize": 12, "fontFamily": 4, "textAlign": "left"},

    {"id": "lazy-mat", "type": "rectangle", "x": 530, "y": 650, "width": 270, "height": 35, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-second-lazy", "type": "arrow"}]},
    {"id": "lazy-mat-text", "type": "text", "x": 540, "y": 660, "width": 250, "height": 16, "text": "optimizeLazyMaterialization2(...)", "fontSize": 11, "fontFamily": 4, "textAlign": "left"},
    {"id": "lazy-mat-note", "type": "text", "x": 530, "y": 690, "width": 250, "height": 16, "text": "◄── 延迟物化第二阶段插入点", "fontSize": 10, "fontFamily": 4, "textAlign": "left", "strokeColor": "#2f9e44"},
    {"id": "lazy-mat-ref", "type": "text", "x": 530, "y": 710, "width": 250, "height": 16, "text": "[optimizeTree.cpp:739]", "fontSize": 9, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "arr-first-second", "type": "arrow", "x": 655, "y": 570, "points": [[0, 0], [0, 15]], "endArrowhead": "arrow", "strokeColor": "#7048e8", "strokeWidth": 1, "startBinding": {"elementId": "opt-first", "focus": 0, "gap": 5}, "endBinding": {"elementId": "opt-second", "focus": 0, "gap": 5}},
    {"id": "arr-second-lazy", "type": "arrow", "x": 655, "y": 630, "points": [[0, 0], [10, 15]], "endArrowhead": "arrow", "strokeColor": "#7048e8", "strokeWidth": 1, "startBinding": {"elementId": "opt-second", "focus": 0, "gap": 5}, "endBinding": {"elementId": "lazy-mat", "focus": 0, "gap": 5}},

    {"id": "arr-pipeline-opt", "type": "arrow", "x": 425, "y": 600, "points": [[0, 0], [50, 0]], "endArrowhead": "arrow", "strokeColor": "#7048e8", "strokeWidth": 1, "strokeStyle": "dashed", "startBinding": {"elementId": "build-pipeline", "focus": 0, "gap": 5}, "endBinding": {"elementId": "optimize-bg", "focus": 0, "gap": 5}},
    {"id": "arr-pipeline-opt-label", "type": "text", "x": 430, "y": 575, "width": 40, "height": 16, "text": "内部调用", "fontSize": 9, "fontFamily": 4, "textAlign": "center", "strokeColor": "#868e96"},

    {"id": "arr-exec-interp", "type": "arrow", "x": 450, "y": 385, "points": [[0, 0], [0, 30]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 2, "startBinding": {"elementId": "exec-query", "focus": 0, "gap": 5}, "endBinding": {"elementId": "interp-bg", "focus": 0, "gap": 5}},

    {"id": "pipeline", "type": "rectangle", "x": 200, "y": 800, "width": 500, "height": 90, "backgroundColor": "#d0bfff", "strokeColor": "#7048e8", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-interp-pipeline", "type": "arrow"}, {"id": "arr-pipeline-output", "type": "arrow"}]},
    {"id": "pipeline-text", "type": "text", "x": 220, "y": 810, "width": 460, "height": 70, "text": "QueryPipeline（Processors 网络）\n\nTCP: PullingAsyncPipelineExecutor::pull(...) 反复拉取 Block\nExecutor: PipelineExecutor::execute(...)", "fontSize": 12, "fontFamily": 4, "textAlign": "left"},
    {"id": "pipeline-ref", "type": "text", "x": 710, "y": 820, "width": 200, "height": 40, "text": "[TCPHandler.cpp:1369]\n[PipelineExecutor.cpp:126]", "fontSize": 9, "fontFamily": 3, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "arr-interp-pipeline", "type": "arrow", "x": 450, "y": 765, "points": [[0, 0], [0, 30]], "endArrowhead": "arrow", "strokeColor": "#7048e8", "strokeWidth": 2, "startBinding": {"elementId": "interp-bg", "focus": 0, "gap": 5}, "endBinding": {"elementId": "pipeline", "focus": 0, "gap": 5}},

    {"id": "output", "type": "rectangle", "x": 350, "y": 930, "width": 200, "height": 50, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-pipeline-output", "type": "arrow"}]},
    {"id": "output-text", "type": "text", "x": 370, "y": 938, "width": 160, "height": 34, "text": "输出结果\n（客户端收到数据块）", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "arr-pipeline-output", "type": "arrow", "x": 450, "y": 895, "points": [[0, 0], [0, 30]], "endArrowhead": "arrow", "strokeColor": "#2f9e44", "strokeWidth": 2, "startBinding": {"elementId": "pipeline", "focus": 0, "gap": 5}, "endBinding": {"elementId": "output", "focus": 0, "gap": 5}}
  ],
  "appState": {"viewBackgroundColor": "#ffffff"},
  "files": {}
}
