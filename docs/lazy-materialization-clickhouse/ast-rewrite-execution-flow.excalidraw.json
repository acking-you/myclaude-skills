{
  "type": "excalidraw",
  "version": 2,
  "source": "https://excalidraw.com",
  "elements": [
    {"id": "title", "type": "text", "x": 350, "y": 30, "width": 300, "height": 32, "text": "AST 重写执行流程", "fontSize": 24, "fontFamily": 4, "textAlign": "center", "strokeColor": "#1e1e1e"},

    {"id": "phase1-bg", "type": "rectangle", "x": 40, "y": 80, "width": 920, "height": 340, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 1, "opacity": 30, "roundness": {"type": 3}},
    {"id": "phase1-title", "type": "text", "x": 60, "y": 100, "width": 300, "height": 24, "text": "阶段 1: 子查询执行（构建 Set）", "fontSize": 18, "fontFamily": 4, "textAlign": "left", "strokeColor": "#1971c2"},
    {"id": "phase1-sql", "type": "text", "x": 60, "y": 130, "width": 880, "height": 20, "text": "SELECT _part_starting_offset + _part_offset FROM hits ORDER BY EventTime LIMIT 1000000", "fontSize": 12, "fontFamily": 3, "textAlign": "left", "strokeColor": "#495057"},

    {"id": "read1", "type": "rectangle", "x": 80, "y": 180, "width": 180, "height": 70, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-read1-sort1", "type": "arrow"}]},
    {"id": "read1-text", "type": "text", "x": 90, "y": 190, "width": 160, "height": 50, "text": "ReadFromMergeTree\n(只读 EventTime\n + 虚拟列)", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "sort1", "type": "rectangle", "x": 320, "y": 180, "width": 180, "height": 70, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-read1-sort1", "type": "arrow"}, {"id": "arr-sort1-limit1", "type": "arrow"}]},
    {"id": "sort1-text", "type": "text", "x": 330, "y": 193, "width": 160, "height": 44, "text": "SortingStep\n(ORDER BY EventTime)", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "limit1", "type": "rectangle", "x": 560, "y": 180, "width": 180, "height": 70, "backgroundColor": "#a5d8ff", "strokeColor": "#1971c2", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-sort1-limit1", "type": "arrow"}, {"id": "arr-limit1-set", "type": "arrow"}]},
    {"id": "limit1-text", "type": "text", "x": 570, "y": 193, "width": 160, "height": 44, "text": "LimitStep\n(LIMIT 1000000)", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},

    {"id": "set-step", "type": "rectangle", "x": 560, "y": 300, "width": 220, "height": 80, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-limit1-set", "type": "arrow"}, {"id": "arr-set-phase2", "type": "arrow"}]},
    {"id": "set-step-text", "type": "text", "x": 570, "y": 310, "width": 200, "height": 60, "text": "CreatingSetsStep\n构建 Set:\n{3, 7, 12, 45, ...}", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},
    {"id": "set-note", "type": "text", "x": 790, "y": 330, "width": 150, "height": 20, "text": "◄── 100万个 offset 值", "fontSize": 11, "fontFamily": 4, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "arr-read1-sort1", "type": "arrow", "x": 265, "y": 215, "points": [[0, 0], [50, 0]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 2, "startBinding": {"elementId": "read1", "focus": 0, "gap": 5}, "endBinding": {"elementId": "sort1", "focus": 0, "gap": 5}},
    {"id": "arr-sort1-limit1", "type": "arrow", "x": 505, "y": 215, "points": [[0, 0], [50, 0]], "endArrowhead": "arrow", "strokeColor": "#1971c2", "strokeWidth": 2, "startBinding": {"elementId": "sort1", "focus": 0, "gap": 5}, "endBinding": {"elementId": "limit1", "focus": 0, "gap": 5}},
    {"id": "arr-limit1-set", "type": "arrow", "x": 650, "y": 255, "points": [[0, 0], [0, 40]], "endArrowhead": "arrow", "strokeColor": "#2f9e44", "strokeWidth": 2, "startBinding": {"elementId": "limit1", "focus": 0, "gap": 5}, "endBinding": {"elementId": "set-step", "focus": 0, "gap": 5}},

    {"id": "phase2-bg", "type": "rectangle", "x": 40, "y": 440, "width": 920, "height": 520, "backgroundColor": "#fff3bf", "strokeColor": "#e67700", "strokeWidth": 1, "opacity": 30, "roundness": {"type": 3}, "boundElements": [{"id": "arr-set-phase2", "type": "arrow"}]},
    {"id": "phase2-title", "type": "text", "x": 60, "y": 460, "width": 300, "height": 24, "text": "阶段 2: 外层查询执行", "fontSize": 18, "fontFamily": 4, "textAlign": "left", "strokeColor": "#e67700"},
    {"id": "phase2-sql", "type": "text", "x": 60, "y": 490, "width": 700, "height": 20, "text": "SELECT * FROM hits WHERE (...) IN (Set) ORDER BY EventTime", "fontSize": 12, "fontFamily": 3, "textAlign": "left", "strokeColor": "#495057"},

    {"id": "read2-bg", "type": "rectangle", "x": 80, "y": 530, "width": 860, "height": 180, "backgroundColor": "#fff3bf", "strokeColor": "#e67700", "strokeWidth": 1, "opacity": 50, "roundness": {"type": 3}, "boundElements": [{"id": "arr-read2-filter", "type": "arrow"}]},
    {"id": "read2-title", "type": "text", "x": 100, "y": 545, "width": 200, "height": 20, "text": "ReadFromMergeTree", "fontSize": 14, "fontFamily": 4, "textAlign": "left", "strokeColor": "#e67700"},

    {"id": "keycond", "type": "rectangle", "x": 100, "y": 575, "width": 820, "height": 80, "backgroundColor": "#ffffff", "strokeColor": "#e67700", "strokeWidth": 1, "roundness": {"type": 3}},
    {"id": "keycond-text", "type": "text", "x": 110, "y": 585, "width": 800, "height": 60, "text": "buildKeyConditionFromTotalOffset()\n将 Set 转换为 KeyCondition，用于 mark range 级别过滤\n\nPart 0: marks [0,5) [8,12) [15,20) ...    Part 1: marks [2,7) [10,15) ...", "fontSize": 11, "fontFamily": 4, "textAlign": "left"},
    {"id": "keycond-note", "type": "text", "x": 700, "y": 600, "width": 200, "height": 20, "text": "◄── 只读命中的 marks", "fontSize": 10, "fontFamily": 4, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "read2-output", "type": "text", "x": 300, "y": 670, "width": 400, "height": 20, "text": "读取所有列（EventTime + URL + UserID + ...）", "fontSize": 12, "fontFamily": 4, "textAlign": "center", "strokeColor": "#495057"},

    {"id": "filter-step", "type": "rectangle", "x": 350, "y": 740, "width": 300, "height": 60, "backgroundColor": "#fff3bf", "strokeColor": "#e67700", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-read2-filter", "type": "arrow"}, {"id": "arr-filter-sort2", "type": "arrow"}]},
    {"id": "filter-step-text", "type": "text", "x": 360, "y": 753, "width": 280, "height": 34, "text": "FilterStep\nIN (Set) 过滤", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},
    {"id": "filter-note", "type": "text", "x": 660, "y": 760, "width": 150, "height": 20, "text": "◄── 行级别精确过滤", "fontSize": 11, "fontFamily": 4, "textAlign": "left", "strokeColor": "#868e96"},

    {"id": "sort2-step", "type": "rectangle", "x": 350, "y": 830, "width": 300, "height": 60, "backgroundColor": "#ffc9c9", "strokeColor": "#c92a2a", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-filter-sort2", "type": "arrow"}, {"id": "arr-sort2-output", "type": "arrow"}]},
    {"id": "sort2-step-text", "type": "text", "x": 360, "y": 843, "width": 280, "height": 34, "text": "SortingStep\nORDER BY EventTime", "fontSize": 12, "fontFamily": 4, "textAlign": "center"},
    {"id": "sort2-note", "type": "text", "x": 660, "y": 840, "width": 200, "height": 34, "text": "◄── ⚠️ 二次排序！\n     100 万行再排一次", "fontSize": 11, "fontFamily": 4, "textAlign": "left", "strokeColor": "#c92a2a"},

    {"id": "output", "type": "rectangle", "x": 420, "y": 920, "width": 160, "height": 40, "backgroundColor": "#b2f2bb", "strokeColor": "#2f9e44", "strokeWidth": 2, "roundness": {"type": 3}, "boundElements": [{"id": "arr-sort2-output", "type": "arrow"}]},
    {"id": "output-text", "type": "text", "x": 460, "y": 930, "width": 80, "height": 20, "text": "输出结果", "fontSize": 14, "fontFamily": 4, "textAlign": "center"},

    {"id": "arr-set-phase2", "type": "arrow", "x": 670, "y": 385, "points": [[0, 0], [0, 50]], "endArrowhead": "arrow", "strokeColor": "#2f9e44", "strokeWidth": 2, "strokeStyle": "dashed", "startBinding": {"elementId": "set-step", "focus": 0, "gap": 5}, "endBinding": {"elementId": "phase2-bg", "focus": 0, "gap": 5}},
    {"id": "arr-read2-filter", "type": "arrow", "x": 500, "y": 715, "points": [[0, 0], [0, 20]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 2, "startBinding": {"elementId": "read2-bg", "focus": 0, "gap": 5}, "endBinding": {"elementId": "filter-step", "focus": 0, "gap": 5}},
    {"id": "arr-filter-sort2", "type": "arrow", "x": 500, "y": 805, "points": [[0, 0], [0, 20]], "endArrowhead": "arrow", "strokeColor": "#e67700", "strokeWidth": 2, "startBinding": {"elementId": "filter-step", "focus": 0, "gap": 5}, "endBinding": {"elementId": "sort2-step", "focus": 0, "gap": 5}},
    {"id": "arr-sort2-output", "type": "arrow", "x": 500, "y": 895, "points": [[0, 0], [0, 20]], "endArrowhead": "arrow", "strokeColor": "#2f9e44", "strokeWidth": 2, "startBinding": {"elementId": "sort2-step", "focus": 0, "gap": 5}, "endBinding": {"elementId": "output", "focus": 0, "gap": 5}}
  ],
  "appState": {"viewBackgroundColor": "#ffffff"},
  "files": {}
}
